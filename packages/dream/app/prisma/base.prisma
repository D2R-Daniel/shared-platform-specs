// Dream Platform — Shared Base Schema
// Copy or extend this in your product's prisma/schema.prisma.
// These models match @dream/types definitions.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ──────────────────────────────────────────────
// NextAuth Models (required by next-auth/prisma-adapter)
// ──────────────────────────────────────────────

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ──────────────────────────────────────────────
// Platform Core Models
// ──────────────────────────────────────────────

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  emailVerified DateTime?
  name          String
  phone         String?
  avatarUrl     String?
  passwordHash  String?
  status        UserStatus @default(active)
  metadata      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // NextAuth relations
  accounts Account[]
  sessions Session[]

  // Platform relations
  memberships    OrganizationMembership[]
  teamMembers    TeamMember[]
  auditEvents    AuditEvent[]              @relation("AuditActor")
  invitationsSent Invitation[]             @relation("InvitationInviter")
  departmentsHead Department[]             @relation("DepartmentHead")

  @@index([email])
  @@index([status])
}

enum UserStatus {
  active
  suspended
  deleted
}

model Organization {
  id           String             @id @default(cuid())
  name         String
  slug         String             @unique
  status       OrganizationStatus @default(active)
  planTier     String             @default("free")
  logoUrl      String?
  primaryColor String?
  domain       String?            @unique
  currency     Currency           @default(INR)
  region       Region             @default(in_mumbai)
  metadata     Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships OrganizationMembership[]
  roles       Role[]
  teams       Team[]
  departments Department[]
  auditEvents AuditEvent[]
  invitations Invitation[]

  @@index([slug])
  @@index([domain])
  @@index([status])
}

enum OrganizationStatus {
  active
  suspended
  archived
}

enum Currency {
  USD
  INR
  EUR
  GBP
}

enum Region {
  us_east
  eu_west
  in_mumbai
  ap_singapore
}

model OrganizationMembership {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  invitedBy      String?
  joinedAt       DateTime @default(now())

  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  roleAssignments RoleAssignment[]

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
}

// ──────────────────────────────────────────────
// Roles & Permissions
// ──────────────────────────────────────────────

model Role {
  id             String  @id @default(cuid())
  name           String
  slug           String
  description    String?
  hierarchyLevel Int
  isBuiltIn      Boolean @default(false)
  isActive       Boolean @default(true)
  organizationId String?
  permissions    Json    // String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization    Organization?    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  roleAssignments RoleAssignment[]

  @@unique([slug, organizationId])
  @@index([organizationId])
  @@index([slug])
}

model RoleAssignment {
  id           String  @id @default(cuid())
  membershipId String
  roleId       String
  isActive     Boolean @default(true)
  assignedBy   String
  assignedAt   DateTime @default(now())

  membership OrganizationMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  role       Role                    @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([membershipId, roleId])
  @@index([membershipId])
  @@index([roleId])
}

// ──────────────────────────────────────────────
// Teams & Departments
// ──────────────────────────────────────────────

model Team {
  id             String  @id @default(cuid())
  name           String
  slug           String
  organizationId String
  ownerId        String
  parentTeamId   String?
  metadata       Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parentTeam   Team?        @relation("TeamHierarchy", fields: [parentTeamId], references: [id])
  childTeams   Team[]       @relation("TeamHierarchy")
  members      TeamMember[]

  @@unique([slug, organizationId])
  @@index([organizationId])
  @@index([parentTeamId])
}

model TeamMember {
  id        String         @id @default(cuid())
  teamId    String
  userId    String
  role      TeamMemberRole @default(member)
  invitedBy String?
  joinedAt  DateTime       @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

enum TeamMemberRole {
  owner
  admin
  member
}

model Department {
  id                 String  @id @default(cuid())
  name               String
  organizationId     String
  headUserId         String?
  parentDepartmentId String?
  path               String  @default("/")
  level              Int     @default(0)
  memberCount        Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  head             User?        @relation("DepartmentHead", fields: [headUserId], references: [id])
  parentDepartment Department?  @relation("DepartmentHierarchy", fields: [parentDepartmentId], references: [id])
  childDepartments Department[] @relation("DepartmentHierarchy")

  @@index([organizationId])
  @@index([parentDepartmentId])
}

// ──────────────────────────────────────────────
// Audit
// ──────────────────────────────────────────────

model AuditEvent {
  id           String @id @default(cuid())
  tenantId     String
  actorId      String
  actorEmail   String
  action       String
  resourceType String
  resourceId   String
  beforeState  Json?
  afterState   Json?
  ipAddress    String @default("0.0.0.0")
  requestId    String @default("")
  metadata     Json?

  timestamp DateTime @default(now())

  organization Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actor        User         @relation("AuditActor", fields: [actorId], references: [id])

  @@index([tenantId])
  @@index([actorId])
  @@index([action])
  @@index([resourceType, resourceId])
  @@index([timestamp])
}

// ──────────────────────────────────────────────
// Invitations
// ──────────────────────────────────────────────

model Invitation {
  id             String           @id @default(cuid())
  organizationId String
  inviterId      String
  inviteeEmail   String
  type           InvitationType   @default(organization)
  teamId         String?
  roleId         String
  status         InvitationStatus @default(pending)
  token          String           @unique
  expiresAt      DateTime
  acceptedAt     DateTime?

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inviter      User         @relation("InvitationInviter", fields: [inviterId], references: [id])

  @@index([organizationId])
  @@index([inviteeEmail])
  @@index([token])
  @@index([status])
}

enum InvitationType {
  organization
  team
  product
}

enum InvitationStatus {
  pending
  accepted
  expired
  revoked
}
